(()=>{"use strict";const e=window.React,t=window.wp.blocks,l=window.wp.blockEditor,a=window.wp.components,n=window.wp.element,o=[{label:"Equals",value:"equals"},{label:"Not Equals",value:"notEquals"},{label:"Contains",value:"contains"},{label:"Does NOT Contain",value:"notContains"},{label:"Starts With",value:"startsWith"},{label:"Ends With",value:"endsWith"},{label:"Exists (any value)",value:"exists"},{label:"Not Exists",value:"notExists"}];(0,t.registerBlockType)("bcgovcleanbc/multi-query-content",{edit:({attributes:t,setAttributes:r})=>{const{placeholderText:s,fallbackText:i,paramKeys:c,combinations:u,previewMode:m,previewValues:d,useOrLogic:v,useParamValueDirect:p,alignment:g="left"}=t,E=(0,l.useBlockProps)({style:{textAlign:g}}),b=(h=c,(u||[]).map((e=>{var t;const l={};return h.forEach((t=>{const a=e?.[t];var n;l[t]=a&&"object"==typeof a&&"value"in a?{value:null!==(n=a.value)&&void 0!==n?n:"",operator:a.operator||"equals"}:"string"==typeof a?{value:a,operator:"equals"}:{value:"",operator:"equals"}})),l.value=null!==(t=e?.value)&&void 0!==t?t:"",l})));var h;const[y,C]=(0,n.useState)(c),x=(0,n.useRef)(null);(0,n.useEffect)((()=>{C(c)}),[c]);const k=e=>{clearTimeout(x.current),x.current=setTimeout((()=>{r({paramKeys:e})}),300)},f=(e,t,l,a)=>{const n=b.map(((n,o)=>{var r;if(o!==e)return n;const s=null!==(r=n[t])&&void 0!==r?r:{value:"",operator:"equals"};return{...n,[t]:{...s,[l]:a}}}));r({combinations:n})},w=b.findIndex((e=>{if(0===y.length)return!1;const t=y.map((t=>{var l;const a=null!==(l=e[t])&&void 0!==l?l:{value:"",operator:"equals"},n=d[t];return((e,t,l)=>{switch(e){case"equals":return l===t;case"notEquals":return l!==t;case"contains":return(null!=l?l:"").includes(null!=t?t:"");case"notContains":return!(null!=l?l:"").includes(null!=t?t:"");case"startsWith":return(null!=l?l:"").startsWith(null!=t?t:"");case"endsWith":return(null!=l?l:"").endsWith(null!=t?t:"");case"exists":return null!=l&&""!=`${l}`;case"notExists":return null==l||""==`${l}`;default:return!1}})(a.operator,a.value,n)}));return v?t.some(Boolean):t.every(Boolean)}));let T=s;if(m)if(p){const e=s.match(/{{\s*value(?:_\d+)?\s*}}/g)||[],t=[...new Set(e.map((e=>{const t=e.match(/\d+/);return t?parseInt(t[0],10)-1:0})))];t.every((e=>{var t;const l=y[e];return l&&""!==(null!==(t=d[l])&&void 0!==t?t:"")}))?(T=s,t.forEach((e=>{const t=y[e],l=d[t]||"";T=T.replace(new RegExp(`{{\\s*value_${e+1}\\s*}}`,"g"),l),0===e&&(T=T.replace(/{{\s*value\s*}}/g,l))}))):T=i||"No fallback text provided."}else{const e=b[w];T=e&&e.value?s.replace(/{{\s*value\s*}}/g,e.value):i||"No fallback text provided."}return(0,e.createElement)(n.Fragment,null,(0,e.createElement)(l.BlockControls,null,(0,e.createElement)(l.AlignmentToolbar,{value:g,onChange:e=>r({alignment:e})})),(0,e.createElement)(l.InspectorControls,null,(0,e.createElement)(a.PanelBody,{title:"Query Parameters"},y.map(((t,l)=>(0,e.createElement)("div",{key:l,style:{marginBottom:"0"}},(0,e.createElement)(a.TextControl,{label:`Param Key #${l+1}`,value:t,onChange:e=>((e,t)=>{const l=[...y],a=[...y];a[e]=t;const n=b.map((e=>{var t;const n={};return a.forEach(((t,a)=>{const o=e[l[a]];n[t]=o?{...o}:{value:"",operator:"equals"}})),n.value=null!==(t=e.value)&&void 0!==t?t:"",n})),o={};a.forEach(((e,t)=>{const a=l[t];a&&Object.prototype.hasOwnProperty.call(d,a)?o[e]=d[a]:o[e]=""})),C(a),k(a),r({combinations:n,previewValues:o})})(l,e)}),(0,e.createElement)("div",{style:{textAlign:"right"}},(0,e.createElement)(a.Button,{isLink:!0,isDestructive:!0,onClick:()=>(e=>{const t=[...y],l=t.splice(e,1)[0],a=b.map((e=>{const t={...e};return delete t[l],t})),n={...d};delete n[l],C(t),k(t),r({combinations:a,previewValues:n})})(l)},"Remove"))))),(0,e.createElement)(a.Button,{isPrimary:!0,onClick:()=>{const e=[...y,""];C(e),k(e);const t=b.map((e=>{const t={...e};return t[""]={value:"",operator:"equals"},t}));r({combinations:t})}},"Add Parameter")),(0,e.createElement)(a.PanelBody,{title:"Value Combinations",initialOpen:!1},(0,e.createElement)("p",null,"If more than one combination is true, the first one found in the following list will be used:"),(0,e.createElement)(a.ToggleControl,{label:"Use parameter query string value(s) as output",checked:p,onChange:e=>{r({useParamValueDirect:e})}}),p&&(0,e.createElement)("div",{style:{padding:"0 0.5rem 1rem",fontSize:"13px",color:"#555"}},(0,e.createElement)("strong",null,"Instructions:"),(0,e.createElement)("br",null),"You can reference each parameterâ€™s value in your placeholder using their value replacement pattern:",(0,e.createElement)("ul",null,y.map(((t,l)=>(0,e.createElement)("li",{key:l,style:{padding:"0 0 0.5rem"}},"For ",(0,e.createElement)("code",null,t)," placeholder use:",(0,e.createElement)("br",null),0===l?"{{value}} or {{value_1}}":`{{value_${l+1}}}`))))),b.map(((t,l)=>(0,e.createElement)("div",{key:`combo-${l}`,style:{marginBottom:"1rem",padding:"0.5rem",opacity:p?.5:1,pointerEvents:p?"none":"auto",border:l===w?"2px solid green":"1px solid #ccc",background:l===w?"#eaffea":"transparent"}},y.map((n=>{var r;const s=null!==(r=t[n])&&void 0!==r?r:{value:"",operator:"equals"},i="exists"===s.operator||"notExists"===s.operator;return(0,e.createElement)("div",{key:`${l}-${n}`,style:{display:"grid",gap:"6px",gridTemplateColumns:"1fr",marginBottom:"8px"}},(0,e.createElement)("div",{style:{fontSize:12,color:"#666",marginBlock:"12px"}},(0,e.createElement)("strong",null,"PARAM KEY: ",(0,e.createElement)("span",{style:{outline:"1px solid #666",padding:"0.25rem",borderRadius:"3px",backgroundColor:"#fff"}},n||"(unnamed param)"))),!i&&(0,e.createElement)(a.TextControl,{label:"Required value",value:s.value,onChange:e=>f(l,n,"value",e)}),(0,e.createElement)("div",{style:{position:"relative",top:"-12px",marginBottom:"-12px"}},(0,e.createElement)(a.SelectControl,{label:"Operator",value:s.operator,options:o,onChange:e=>f(l,n,"operator",e)})))})),(0,e.createElement)("div",{style:{borderTop:"1px solid #333",paddingTop:"12px"}},(0,e.createElement)(a.TextControl,{label:"Output Value",value:t.value,onChange:e=>((e,t)=>{const l=b.map(((l,a)=>a!==e?l:{...l,value:t}));r({combinations:l})})(l,e)})),(0,e.createElement)("div",{style:{textAlign:"right"}},(0,e.createElement)(a.Button,{isLink:!0,isDestructive:!0,onClick:()=>(e=>{const t=b.slice();t.splice(e,1),r({combinations:t})})(l)},"Remove Combination"))))),(0,e.createElement)(a.Button,{isPrimary:!0,onClick:()=>{const e=Object.fromEntries(y.map((e=>[e,{value:"",operator:"equals"}])));e.value="",r({combinations:[...b,e]})},disabled:p},"Add Combination")),(0,e.createElement)(a.PanelBody,{title:"Editor Preview",initialOpen:!1},(0,e.createElement)(a.ToggleControl,{label:"Enable Preview Mode",checked:m,onChange:e=>r({previewMode:e})}),(0,e.createElement)(a.ToggleControl,{label:"Use OR Logic (match any)",checked:v,onChange:e=>r({useOrLogic:e})}),m&&y.map(((t,l)=>(0,e.createElement)(a.TextControl,{key:t||`pv-${l}`,label:`Preview value for "${t||"(unnamed)"}"`,value:d[t]||"",onChange:e=>((e,t)=>{r({previewValues:{...d,[e]:t}})})(t,e)}))),(0,e.createElement)(a.TextControl,{label:"Fallback Text (when nothing matches)",value:i,onChange:e=>r({fallbackText:e})}))),(0,e.createElement)("div",{...E},(0,e.createElement)(l.RichText,{tagName:"div",value:m?T:s,onChange:e=>r({placeholderText:e}),placeholder:m&&""===i?`No fallback text provided. Content with replacement pattern: ${s}`:void 0})))},save:()=>null});const r=[{label:"Equals",value:"equals"},{label:"Not Equals",value:"notEquals"},{label:"Contains",value:"contains"},{label:"Starts With",value:"startsWith"},{label:"Ends With",value:"endsWith"},{label:"Regex Match",value:"regex"},{label:"Exists (any value)",value:"exists"},{label:"Not Exists",value:"notExists"}];(0,t.registerBlockType)("bcgovcleanbc/query-conditional-group",{edit:({attributes:t,setAttributes:o})=>{const{rules:s=[],logic:i,invert:c,caseSensitive:u,clientSideCheck:m,hideUntilJs:d}=t,v=(0,l.useBlockProps)({className:"query-conditional-group-block",style:d?{outline:"1px dashed lightgray",outlineOffset:"0.5rem",marginBlock:"1rem"}:void 0}),p=(e,t,l)=>{const a=[...s];a[e]={...a[e],[t]:l},o({rules:a})};return(0,e.createElement)(n.Fragment,null,(0,e.createElement)(l.InspectorControls,null,(0,e.createElement)(a.PanelBody,{title:"Query Rules"},s.map(((t,l)=>(0,e.createElement)("div",{key:l,style:{border:"1px solid #ddd",padding:"8px",marginBottom:"8px"}},(0,e.createElement)(a.TextControl,{label:"Query key",value:t.key,onChange:e=>p(l,"key",e)}),!("exists"===t.operator||"notExists"===t.operator)&&(0,e.createElement)(a.TextControl,{label:"Required value",value:t.value,onChange:e=>p(l,"value",e)}),(0,e.createElement)(a.SelectControl,{label:"Operator",value:t.operator,options:r,onChange:e=>p(l,"operator",e)}),(0,e.createElement)(a.ToggleControl,{label:"Case Sensitive",checked:t.caseSensitive,onChange:e=>p(l,"caseSensitive",e)}),(0,e.createElement)("div",{style:{textAlign:"right"}},(0,e.createElement)(a.Button,{isLink:!0,isDestructive:!0,onClick:()=>(e=>{const t=[...s];t.splice(e,1),o({rules:t})})(l)},"Remove"))))),(0,e.createElement)(a.Button,{variant:"primary",onClick:()=>{o({rules:[...s,{key:"",value:"",operator:"equals",caseSensitive:!1}]})}},"Add rule")),(0,e.createElement)(a.PanelBody,{title:"Settings",initialOpen:!1},(0,e.createElement)(a.SelectControl,{label:"Logic Between Rules",value:i,options:[{label:"AND (all rules must match)",value:"AND"},{label:"OR (any rule matches)",value:"OR"}],onChange:e=>o({logic:e})}),(0,e.createElement)(a.ToggleControl,{label:"Invert (Show when NOT matching)",checked:c,onChange:e=>o({invert:e})}),(0,e.createElement)(a.ToggleControl,{label:"Case Sensitive (Global Default)",checked:u,onChange:e=>o({caseSensitive:e})}),(0,e.createElement)(a.ToggleControl,{label:"Enable Client-Side Check",checked:m,onChange:e=>o({clientSideCheck:e})}),(0,e.createElement)(a.ToggleControl,{label:"Hide Until JS Runs (Editor Hint)",checked:d,onChange:e=>o({hideUntilJs:e})}))),(0,e.createElement)("div",{...v},(0,e.createElement)("div",{style:{fontSize:"12px",color:"#aaa",marginBlock:"8px"}},"Conditional content: will only render if query rules match."),(0,e.createElement)(l.InnerBlocks,{templateLock:!1})))},save:()=>(0,e.createElement)(l.InnerBlocks.Content,null)});(0,t.registerBlockType)("bcgovcleanbc/query-filter-block",{edit:({attributes:t,setAttributes:o})=>{var r;const{selectedTaxonomy:s,label:i}=t,[c,u]=(0,n.useState)({}),m=null!==(r=window.queryFilterBlockData?.query)&&void 0!==r?r:{};(0,n.useEffect)((()=>{var e;fetch("/wp-json/custom/v1/meta-categories",{headers:{"X-WP-Nonce":null!==(e=window.queryFilterBlockData?.nonce)&&void 0!==e?e:""}}).then((e=>e.json())).then((e=>u(e)))}),[]);const d=s&&c[s]?[{label:"-- Select --",value:""},...c[s].map((({slug:e,name:t})=>({label:t,value:e})))]:[],v=(0,l.getTypographyClassesAndStyles)(t),p=(0,l.getColorClassName)("color",t.textColor),g=[v.className,p].filter(Boolean).join(" ");return(0,e.createElement)("div",{...(0,l.useBlockProps)({className:"query-filter-block","data-initialized":"false"})},(0,e.createElement)(l.InspectorControls,null,(0,e.createElement)(a.PanelBody,{title:"Filter Settings",initialOpen:!0},(0,e.createElement)(a.SelectControl,{label:"Select Taxonomy",value:s,onChange:e=>o({selectedTaxonomy:e}),options:Object.keys(c).map((e=>({label:e.replace(/-/g," "),value:e})))}),(0,e.createElement)(a.TextControl,{label:"Label Text",value:i,onChange:e=>o({label:e})}))),s&&d.length?(0,e.createElement)("div",{className:"query-filter-group"},(0,e.createElement)("label",{htmlFor:`select-${s}`,className:g,style:{...v.style,color:p?void 0:t.style?.color?.text}},i),(0,e.createElement)(a.SelectControl,{id:`select-${s}`,name:s,value:m[s]?.[0]||"",onChange:e=>(e=>{const t={...m};e?t[s]=[e]:delete t[s];const l=new URLSearchParams;for(const e in t)t[e].forEach((t=>l.append(e,t)));const a=document.querySelector(".query-filter-block");a?(a.classList.add("fade-out"),setTimeout((()=>{window.location.href=`${window.location.pathname}?${l.toString()}`}),200)):window.location.href=`${window.location.pathname}?${l.toString()}`})(e),options:d})):(0,e.createElement)(a.Spinner,null))},save:()=>null}),document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector(".query-filter-block");console.log(e),e&&window.queryFilterBlockData}))})();